---
title: "New MAGE model in BaM"
author: "Felipe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  fig.align = "center"
)
```
```{r load-packages, message = FALSE, include= FALSE}
library(RBaM)
library(gridExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
```

# Features in BaM for MAGE_ZQV_model:

The new features in BaM for the MAGE model calibration include:

- Model with 4 input variables:
  - **X1**: event number starting from 1.
  - **X2**: reach number starting from 1.
  - **X3**: position coordinate in the reach. Units depends on the MAGE projet.
  - **X4**: time coordinate in **seconds**.
- Model with 5 output variables. Units depends on the MAGE projet:
  - **Y1**: water surface elevation (WSE).
  - **Y2**: discharge.
  - **Y3**: velocity. 
  - **Y4**: friction in the main channel (Kmin). 
  - **Y5**: friction in the floodplain (Kmoy). 
  
- Multiple events is supported. 
- Multiple reaches is supported.
- Get simulation data using the `.BIN` file.
- Interpolation in time and space is supported.
- Spatialisation of the parameters using Legendre polynomial method is supported.

# Remarks:

- Add the idea of a hydraulic unit, which is a set of reaches with the same spatially distributed friction. This approach led us to manage the tributary and the main river differently. 
- To run parallel calibration varying either the number of events or degree of the Legendre polynomial, it is mandatory to specify several folders.
- Spatial-temporal error model specified to each output variable: WSE, discharge, velocity, friction in the main channel, and friction in the floodplain **(need to be developed)**
- The model can receive velocity measurements during calibration, but it is necessary to implement the velocity simulaiton in mage based on wetted area and discharge to get the simulation data.

# Setup for the MAGE model

The data is stored in a text file named `CalibrationData.txt`. The data includes the following columns with -9999 as missing values:

- **Event**: event number.
- **Reach**: reach number.
- **x**: position coordinate in the reach.
- **t**: time coordinate in the reach.
- **Y_Z**: observed water surface elevation (WSE).
- **Y_Q**: observed discharge.
- **Y_V**: observed velocity.
- **Yu_Z**: uncertainty of the observed water surface elevation (WSE).
- **Yu_Q**: uncertainty of the observed discharge.
- **Yu_V**: uncertainty of the observed velocity.


```{r}
path <- "/home/famendezrios/Documents/These/VSCODE-R/HydroBayes/HydroBayes_git/Case_studies/HHLab/Rectangular_channel/Calibration_experiments/4_WSE_main_channel_real_uncertainty/n_0/Calibration/"
# Read calibration data and summary
getCalData <- read.table(
  file = file.path(path, "CalibrationData.txt"),
  header = TRUE,
  stringsAsFactors = FALSE
)
knitr::kable(getCalData,
  align = "c"
)

knitr::include_graphics("/home/famendezrios/Documents/These/VSCODE-R/HydroBayes/HydroBayes_git/Case_studies/HHLab/Rectangular_channel/Calibration_experiments/4_WSE_main_channel_real_uncertainty/CalData_plot.png")
```


# Workflow

```{r}
knitr::include_graphics("/home/famendezrios/Documents/These/VSCODE-R/HydroBayes/HydroBayes_git/xtra/workflow_1.png")
```

```{r}
knitr::include_graphics("/home/famendezrios/Documents/These/VSCODE-R/HydroBayes/HydroBayes_git/xtra/workflow_2.png")
```